<!--Citation for the following function --> 
<!-- Date: 02/27/2025  (Update to the date you copied/used it) -->
<!-- Copied from /OR/ Adapted from /OR/ Based on: -->
<!-- Source URL: https://github.com/osu-cs340-ecampus/flask-starter-app -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriSphere: Users</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"> <!-- Link to CSS file for styling -->
</head>
<body>
    <!-- Navigation Bar -->
    <header>
        <h1>NutriSphere: Users</h1>
        <nav>
            <a href="{{ url_for('home') }}">ğŸ  Home</a>
            <a href="{{ url_for('users') }}">ğŸ‘¤ Users</a>
            <a href="{{ url_for('daily_trackers') }}">ğŸ—“ï¸ Daily Trackers</a>
            <a href="{{ url_for('food_entries') }}">ğŸ½ï¸ Food Entries</a>
            <a href="{{ url_for('food_items') }}">ğŸ¥— Food Items</a>
            <a href="{{ url_for('exercises') }}">ğŸ‹ï¸ Exercises</a>
        </nav>
    </header>
    

    <!-- User List Section -->
    <main>
        <h2>Browse Users</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Daily Calorie Goal</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Sample Data (Static) -->
                <tr>
                    <td>1</td>
                    <td>Tyler</td>
                    <td>tyler@oregonstate.edu</td>
                    <td>2400</td>
                    <td>
                        <button onclick="populateUpdateForm(1)">âœï¸ Edit</button>
                        <button onclick="deleteUser(1, true)">âŒ Delete</button>
                    </td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Jane</td>
                    <td>jane@oregonstate.edu</td>
                    <td>2000</td>
                    <td>
                        <button onclick="populateUpdateForm(2)">âœï¸ Edit</button>
                        <button onclick="deleteUser(2, true)">âŒ Delete</button>
                    </td> 
                </tr>
                <tr>
                    <td>3</td>
                    <td>Alex</td>
                    <td>alex@oregonstate.edu</td>
                    <td>2200</td>
                    <td>
                        <button onclick="populateUpdateForm(3)">âœï¸ Edit</button>
                        <button onclick="deleteUser(3, true)">âŒ Delete</button>
                </tr>

                <!-- âœ… Database Users -->
                {% for user in users %}
                <tr id="userRow-{{ user.userID }}">
                    <td>{{ user.userID }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.dailyCalorieGoal }}</td>
                    <td>
                        <button onclick="populateUpdateForm({{ user.userID }})">âœï¸ Edit</button>
                        <button onclick="deleteUser({{ user.userID }}, false)">âŒ Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <!-- Add User Form -->
    <section>
        <h2>Add a New User</h2>
        <form action="{{ url_for('add_user') }}" method="post">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>

            <label for="dailyCalorieGoal">Daily Calorie Goal:</label>
            <input type="number" id="dailyCalorieGoal" name="dailyCalorieGoal" required>

            <button type="submit">â• Add User</button>
        </form>
    </section>

   <!-- Update User Form -->
    <h2>Update User</h2>
    <form id="updateUserForm" action="/update_user" method="POST">
        <input type="hidden" id="update_user_id" name="user_id">

        <label for="update_email">Email:</label>
        <input type="email" id="update_email" name="email" required>

        <label for="update_calorieGoal">Daily Calorie Goal:</label>
        <input type="number" id="update_calorieGoal" name="dailyCalorieGoal" required>

        <button type="submit">Update User</button>
    </form>

    <script>
        // Define sample user data
        let users = {};  // Initialize the users object
        
        // Load database users from Flask (dynamic)
        {% for user in users %}
        users["{{ user.userID }}"] = {
            username: "{{ user.username }}",
            email: "{{ user.email }}",
            calorieGoal: "{{ user.dailyCalorieGoal }}"
        };
        {% endfor %}
    
        // Function to populate the update form with user data
        function populateUpdateForm(userID) {
            if (userID && users[userID]) {
                document.getElementById("update_user_id").value = userID;
                document.getElementById("update_email").value = users[userID].email;
                document.getElementById("update_calorieGoal").value = users[userID].calorieGoal;
            }
        }

    
        // Function to populate delete form when a user is selected
        function populateDeleteForm(userID) {
            console.log(`ğŸ› ï¸ Populating delete form for user ID: ${userID}`);

            if (!userID || !users[userID]) {
                alert("âŒ Error: User not found or invalid selection.");
                return;
            }

            // Populate the form fields
            document.getElementById("delete_user_id").value = userID;
            document.getElementById("delete_username").innerText = users[userID].username;
            document.getElementById("delete_email").innerText = users[userID].email;
            document.getElementById("delete_calorieGoal").innerText = users[userID].calorieGoal;
        }   
        
        // Define the deleteUser function
        function deleteUser(userID, isSampleUser) {
            console.log("Attempting to delete user ID:", userID, "Is Sample:", isSampleUser);

            // Handle the confirmation prompt
            if (!userID) {
                alert("No user ID provided!");
                return;
            }

            if (confirm(`Are you sure you want to delete user ID ${userID}?`)) {
                fetch(`/delete_user/${userID}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(`âœ… User ${userID} deleted successfully!`);
                
                        // Remove row from table dynamically
                        let userRow = document.getElementById(`userRow-${userID}`);
                        if (userRow) {
                            userRow.remove();
                        } else {
                            console.warn("User row not found in the table.");
                        }

                        // Remove from local users object
                        delete users[userID];

                    } else {
                        alert("âŒ Failed to delete user!");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("âŒ An error occurred while deleting the user.");
                });
            }
        }
        document.getElementById("addUserForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent full page reload

            let formData = new FormData(this);

            fetch("/add_user", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    let newRow = document.createElement("tr");
                    newRow.id = `userRow-${data.userID}`;
                    newRow.innerHTML = `
                        <td>${data.username}</td>
                        <td>${data.email}</td>
                        <td>${data.dailyCalorieGoal}</td>
                        <td>
                            <button onclick="populateUpdateForm(${data.userID})">Update</button>
                            <button onclick="deleteUser(${data.userID})">Delete</button>
                        </td>
                    `;
                    document.getElementById("usersTable").appendChild(newRow);
            
                    users[data.userID] = { username: data.username, email: data.email, calorieGoal: data.dailyCalorieGoal };
                    alert(`âœ… User ${data.username} added successfully!`);
                }
            })
            .catch(error => console.error("Error:", error));
        });
    </script>
    
</body>
</html>