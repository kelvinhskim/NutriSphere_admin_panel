<!-- Citation for Fetch API -->
<!-- Date: 03/11/2025 -->
<!-- Copied from -->
<!-- Source URL: https://www.geeksforgeeks.org/javascript-fetch-method/ -->
<!-- Source URL: https://flask.palletsprojects.com/en/stable/patterns/javascript/#making-a-request-with-fetch -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriSphere: Daily Trackers</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"> <!-- Link to CSS file for styling -->
</head>
<body>
    <!-- Navigation Bar -->
    <header>
        <h1>NutriSphere: Daily Trackers</h1>
        <nav>
            <a href="{{ url_for('home') }}">üè† Home</a>
            <a href="{{ url_for('users') }}">üë§ Users</a>
            <a href="{{ url_for('daily_trackers') }}">üóìÔ∏è Daily Trackers</a>
            <a href="{{ url_for('food_entries') }}">üçΩÔ∏è Food Entries</a>
            <a href="{{ url_for('food_items') }}">ü•ó Food Items</a>
            <a href="{{ url_for('exercises') }}">üèãÔ∏è Exercises</a>
        </nav>
    </header>

    <!-- Daily Trackers Table Section -->
    <main id="daily-trackers-table">
        <h2>Daily Trackers</h2>
        <table border="1">
            <thead>
                <!-- Access queried table headers passed from daily-trackers route -->
                <tr>
                {% if daily_trackers %}
                    {% for key in daily_trackers[0].keys() %}
                    <th>{{ key }}</th>
                    {% endfor %}
                    <th>Actions</th>
                    {% else %}
                    <th>No data available</th>
                {% endif %}
                </tr>
            </thead>

            <!-- Access queried table data passed from daily-trackers route -->
            <tbody>
            {% if daily_trackers %}
                {% for tracker in daily_trackers %}
                <tr>
                    {% for key in tracker.keys() %}
                    <td> {{ tracker[key] }} </td>
                    {% endfor %} 
                    <td>
                        <button class="edit-btn" onclick="populateUpdateTracker({{ tracker["Daily Tracker ID"] }})">‚úèÔ∏è Edit</button>
                        <button 
                            class="delete-btn" 
                            onclick='deleteTracker({{ tracker["Daily Tracker ID"] }}, "{{ tracker["Username"] }}", "{{ tracker["Date"] }}")'
                        >
                            ‚ùå Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="100%">No trackers found.</td>
                </tr>
            {% endif %}  
            </tbody>
        </table>
    </main>

    <!-- Add Daily Tracker Form -->
    <section id="add-tracker">
        <form action="{{ url_for("add_tracker") }}" method="post">
            <fieldset>
                <h2>Add New Daily Tracker</h2>
                <label>Select a User</label>
                <select id="selectedUser" name="userID" onchange=getSelectedUser() required>
                    <option value="" selected disabled hidden></option>
                    {% for user in users %}
                    <option 
                        value="{{ user.userID }}"
                        data-username="{{ user.username }}"
                        data-calorie-goal="{{ user.dailyCalorieGoal }}"
                    >
                        {{ user.username }}
                    </option>
                    {% endfor %}
                    {% for user in users %}
                    <option 
                        value="{{ user.userID }}"
                        data-username="{{ user.username }}"
                        data-calorie-goal="{{ user.dailyCalorieGoal }}"
                    >
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>

                <label>Date</label>
                <input type="date" id="date" name="date" value="">

                <label>Calorie Goal</label>
                <input type="number" id="calorieGoal" name="calorieGoal" value="" required>

                <label>Exercise</label>
                <select id="exercise" name="exerciseID">
                    <option value="NULL" selected></option>
                    {% for exercise in exercises %}
                    <option id="exercise" name="exerciseID" value={{ exercise.exerciseID }}>{{ exercise.name }}</option>
                    {% endfor %}
                </select>

                <button type="submit" name="Add_Daily_Tracker" value="submit">Add</button>

                <p>Note: Calories consumed, calories burned, and calories remaining would be calculated and populated
                    through a query after adding a daily tracker.</p>
            </fieldset>
        </form>
    </section>

    <!-- Update Daily Tracker Form -->
    <section id="update-tracker-section">
        <form id="update-tracker-form">
            <fieldset>
                <h2>Edit Daily Tracker</h2>
                <label>Select a Daily Tracker:</label>
                <select id="selectedTracker" name="trackerID" onchange="getSelectedTracker()">
                    <option value="" selected disabled hidden></option>
                    {% for tracker in daily_trackers_dropdown %}
                    <option value="{{ tracker.dailyTrackerID }}">
                        {{ tracker.dailyTrackerID }}: {{ tracker.username }}, {{ tracker.date }}
                    </option>
                    {% endfor %}
                    
                </select>
                <label>Username:</label>
                <select id="update-user-id" name="userID">
                    <option value="" selected disabled hidden></option>
                    {% for user in users %}
                    <option 
                        value="{{ user.userID }}"
                        data-username="{{ user.username }}"
                    >
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>
                <label>Date:</label>
                <input type="date" id="update-date" name="date" value="">

                <label>Calorie Goal</label>
                <input type="number" id="update-calorie-goal" name="calorie-goal" value="">

                <label>Exercise</label>
                <select id="update-exercise" name="exerciseID">
                    <option value="NULL" selected></option>
                    {% for exercise in exercises %}
                    <option id="exercise" name="exerciseID" value={{ exercise.exerciseID }}>{{ exercise.name }}</option>
                    {% endfor %}
                </select>

                <button type="button" onclick='submitUpdateTracker()'>Save</button>
                
                <p>Note: Calories consumed, calories burned, and calories remaining would be auto-calculated through a query after updating a daily tracker.</p>
            </fieldset>
        </form>
    </section>

    <!-- Delete Daily Tracker Form
    <section id="delete-tracker-section">
        <form>
            <fieldset>
                <h2>Delete Daily Tracker</h2>
                <p>Are you sure you want to delete this?</p>
                <label>Daily Tracker ID:</label>
                <input type="number" id="delete-tracker-id" name="trackerID" value="" disabled>
                <label>Username:</label>
                <input type="text" id="delete-username" value="" disabled>
                <label>Date:</label>
                <input type="date" id="delete-date" value="" disabled>
                <label>Exercise:</label>
                <select id="delete-exercise" value="" disabled>
                    <option value="" selected></option>
                    <option></option>
                </select>
                <button onclick=deleteTracker(document.getElementById("delete-tracker-id").value)>Confirm Delete</button>
            </fieldset>
        </form> -->
    </section>


    <script language="Javascript">
        // dynamically populates calorie goal on Add New Tracker form when a user is selected from the dropdown
        function getSelectedUser() {
            let selectedUser = document.getElementById("selectedUser");
            let userID = selectedUser.value;
            let username = selectedUser.options[selectedUser.selectedIndex].getAttribute("data-username")
            let calorieGoal = selectedUser.options[selectedUser.selectedIndex].getAttribute("data-calorie-goal")
            console.log("selectedUser:", userID, username, calorieGoal)
            
            // populates default field value for Calorie Goal in Add Daily Tracker form
            document.getElementById("calorieGoal").value = calorieGoal
        }

        let trackers = {}
        {% for tracker in daily_trackers_dropdown %}
            {% if not tracker.exerciseID %}
            trackers[{{ tracker.dailyTrackerID }}] = {
                userID: {{ tracker.userID }},
                username: "{{ tracker.username }}",
                date: "{{ tracker.date }}",
                calorieGoal: {{ tracker.calorieGoal }},
                exerciseID: "NULL"
            }
            {% else %}
                trackers[{{ tracker.dailyTrackerID }}] = {
                    userID: {{ tracker.userID }},
                    username: "{{ tracker.username }}",
                    date: "{{ tracker.date }}",
                    calorieGoal: {{ tracker.calorieGoal }},
                    exerciseID: {{ tracker.exerciseID }}
                }
            {% endif %}
        {% endfor %}
        // console.log("Trackers:", trackers)

        // populates Update Tracker on selection of tracker from dropdown
        function getSelectedTracker() {
            let selectedTracker = document.getElementById("selectedTracker");
            let trackerID = selectedTracker.value;
            document.getElementById("update-user-id").value = trackers[trackerID].userID
            document.getElementById("update-date").value = trackers[trackerID].date
            document.getElementById("update-calorie-goal").value = trackers[trackerID].calorieGoal
            document.getElementById("update-exercise").value = trackers[trackerID].exerciseID
            console.log("selectedTracker:", trackerID);
        }

        // populates Update Tracker on click Edit button
        function populateUpdateTracker(id) {
            // populates selected tracker on Update Daily Tracker form when corresponding Edit button is clicked
            const tracker = trackers[id]
            document.getElementById("selectedTracker").value = id
            document.getElementById("update-user-id").value = tracker.userID
            document.getElementById("update-date").value = tracker.date
            document.getElementById("update-calorie-goal").value = tracker.calorieGoal
            document.getElementById("update-exercise").value = tracker.exerciseID
            console.log("populating update tracker:", id, tracker.username, tracker.date, tracker.calorieGoal, tracker.exerciseID)
        }

        function submitUpdateTracker() {
            id = document.getElementById("selectedTracker").value
            userID = document.getElementById("update-user-id").value
            date = document.getElementById("update-date").value
            calorieGoal = document.getElementById("update-calorie-goal").value
            exerciseID = document.getElementById("update-exercise").value
            
            const URL = `/daily-trackers/${id}`;
            const data = { date, calorieGoal, userID, exerciseID };
            // use fetch to handle update request to edit a selected tracker
            fetch(URL, {
                method: "PUT",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json()
                } else {
                    throw Error(`${response.status}`)
                }
            })
            .then(response => window.location = response.redirect_url)
            .catch(error => console.error(error))
        }

        // // populates Delete Tracker form on click Delete button
        // function populateDeleteTracker(id) {
        //     document.getElementById("delete-tracker-id").value = id
        //     document.getElementById("delete-username").value = trackers[id].username
        //     document.getElementById("delete-date").value = trackers[id].date
        //     document.getElementById("delete-exercise").value = trackers[id].exerciseID
        //     console.log("populating delete tracker:", id, trackers[id].username, trackers[id].date, trackers[id].exerciseID)
        // }

        // use fetch to handle delete request to remove a selected tracker
        function deleteTracker(id, username, date) {
            const URL = `/daily-trackers/${id}`
            if (confirm(
                `Are you sure you want to delete this tracker?
                Daily Tracker ID: ${id}
                Username: ${username}
                Date: ${date}
                `
            )) {
                fetch(URL, {
                    method: "DELETE"
                })
                .then(response => {
                    if (response.ok) {
                        return response.json()
                    } else {
                        throw Error(`${response.status}`)
                    }
                })
                .then(data => window.location = data.redirect_url)
                .catch(error => console.error(error));
            }
        }
    </script>


    <!-- <script>
        function showUpdateForm() {
            let updateForm = document.getElementById("update-daily-tracker");
            let deleteForm = document.getElementById("delete-daily-tracker");
            if (updateForm.style.display = "none") {
                updateForm.style.display = "block";
                document.getElementById("daily-trackers-table").style.display = "none";
                document.getElementById("add-daily-tracker").style.display = "none";
            } else if (deleteForm.style.display = "none") {
                deleteForm.style.display = "block";
                document.getElementById("daily-trackers-table").style.display = "none";
                document.getElementById("add-daily-tracker").style.display = "none";
            }
            else {
                updateForm.style.display = "none"
            }
        }
        function showDeleteForm() {
            let deleteForm = document.getElementById("delete-daily-tracker");
            if (deleteForm.style.display = "none") {
                deleteForm.style.display = "block";
                document.getElementById("daily-trackers-table").style.display = "none";
                document.getElementById("add-daily-tracker").style.display = "none";
            }
            else {
                updateForm.style.display = "none"
            }
        }
    </script> -->

</body>
</html>
